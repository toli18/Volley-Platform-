# Volley-Platform-

Volley Platform — единна система за тренировки, упражнения и методика по волейбол.

## Wireframe

Статичният прототип се намира в `index.html` и показва ключовите раздели:
- Начало / Хиро секция
- Карти за Упражнения, Генератор, Методика, Моите тренировки и Форум
- Раздел „Методика и статии” с филтри и примерни статии (публикувана, чака одобрение, чернова)
- Форум, детайл на упражнение, генератор на тренировки и списък с мои тренировки с повече данни (статуси, автори)
- Одобрения за bfv_admin (упражнения, статии, модерация), управление на клубове и бързи сценарии по роли

Добавен е и раздел „Роли в платформата“ с права на platform_admin, bfv_admin и coach, плюс примерни състояния и статуси за всяка роля. В секцията „Демо с Mock API“ има селектор „Преглед по роля“, който показва права и ключови действия според заредените (или примерни) данни от API.

Отворете файла локално в браузър, за да прегледате макета. В секцията „Демо с Mock API“ може да заредите данни от `prototype/mock_api.py` (по подразбиране `http://localhost:8001`). Ако стартирате mock API-то и го отворите в браузър (Accept: text/html), то ще сервира директно `index.html`, така че в хостинг като Render може да получите и UI, и JSON от една услуга.

## Тестване / преглед

### Бързи команди (стъпка по стъпка)
1. Стартирайте mock API (по избор, за да имате живи данни):
   ```bash
   python prototype/mock_api.py
   ```
   - Сървърът слуша на `http://localhost:8001` (или на порта от променливата `PORT`, ако е зададена) и връща JSON за упражнения, тренировки, клубове, роли и чакащи одобрения.
   - Промените (предложи/одобри) се записват във `prototype/data.json`. Ако искате чист старт, ползвайте бутона „Рестартирай API данните" в UI-то или извикайте `POST /api/reset`.
2. Отворете фронтенда:
   - Вариант А: директно в браузър — отворете `index.html` с двойно кликане или „Open File“.
   - Вариант Б: стартирайте лек сървър и отворете `http://localhost:8000/index.html`:
     ```bash
     python -m http.server 8000
     ```
3. В секцията „Демо с Mock API“ натиснете бутона „Зареди данни“ (или изчакайте автоматичното зареждане), за да видите:
   - Упражнения, тренировки и клубове с актуални статуси;
   - Чакащи одобрения, групирани по тип;
   - „Преглед по роля“ с права и действия за platform_admin, bfv_admin и coach.
   - Ролеви превключвател, който контролира кой вижда/може да ползва бутоните „Предложи“, „Одобри“ и „Откажи“.
   - Статистики за броя упражнения/клубове/pending елементи (от `/api/stats` или локално изчислени при fallback).
   - Ако UI и API се обслужват от един и същ адрес (например на Render), полето за API се попълва автоматично с текущия адрес и може да зареждате данни без ръчни промени.
   - Полето за API се запазва в браузъра при успешно зареждане; бутон „Изчисти / локален“ връща стойността към открития домейн
или `http://localhost:8001`.
   - Лентата под бутоните показва последно обновяване, health статус и дали данните са от API или fallback.
   - Бутон „Копирай линк с роля/API“ генерира URL с параметри `?api=...&role=...` за споделяне към треньори; ако клипбордът е недостъпен, показва тост с инструкция за ръчно копиране.
4. Ако mock API не е стартиран, страницата показва примерни (fallback) данни, за да проверите оформлението.

### Ръчен преглед (кратко резюме)
Ако просто искате визуална проверка без бекенд, отворете `index.html` и преминете през основните панели: навигация, хиро, карти, методика, форум, детайл на упражнение, генератор, „Моите тренировки“, одобрения, клубове и роли. Статусните бейджове остават видими дори без API.

Няма автоматизирани тестове за статичния прототип. За преглед:
- Отворете `index.html` директно в браузър, или
- Стартирайте локален сървър с `python -m http.server 8000` и посетете `http://localhost:8000/index.html`.
- (По желание) Стартирайте mock API: `python prototype/mock_api.py` и натиснете „Зареди данни“ в секцията „Демо с Mock API“ за живи примери.

### Mock API демо
- API панелът показва упражнения, тренировки, клубове (статус + броя треньори срещу лимит), чакащи одобрения и права по роли.
- При недостъпен API се визуализират примерни данни, за да се види структурата.
- Ролевият селектор (platform_admin / bfv_admin / coach) променя достъпността на бутоните: предлагане на упражнения (coach/bfv_admin) и одобряване/отказ (bfv_admin/platform_admin). При грешка/успех се показват тост нотификации.
- Контролният бар има бутон „Провери health“ и индикатор „Health: …“, които извикват `/health` (или `/api` при нужда) за текущия адрес.
- Контролният бар показва и статистики от `/api/stats` (брой упражнения, клубове, pending) или локално изчислени при fallback.
- Може да споделите линк с параметри `?api=https://...&role=coach`, за да се попълни автоматично адресът и началната роля при зареждане. Бутонът „Копирай линк с роля/API“ генерира и копира този адрес.

### Ръчен чеклист
- Навигацията показва всички връзки: Начало, Упражнения, Генератор, Моите тренировки, Методика, Общност, Настройки.
- Хиро секцията съдържа заглавие „Добре дошли в Volley Platform“ и кратко описание.
- Картираните секции за упражнения, генератор, методика и форум са подравнени в мрежа и четими на различни ширини.
- Раздел „Методика и статии“ показва филтри и списък с примерни статии със статуси (Публикувано, Чака одобрение, Чернова).
- Демонстрационните упражнения съдържат маркировки кой ги е предложил/одобрил и какъв е статусът им.
- Раздел „Форум / Общност“ съдържа поне пет категории.
- Детайлът на упражнение включва място за видео/снимка, статус „Одобрено“ и бутон „Добави към тренировка“.
- Генераторът на тренировки показва настройки отляво и три генерирани упражнения с различни статуси.
- Раздел „Моите тренировки“ показва минимум три примерни тренировки със статуси (Запазена, Одобрена, Чернова).
- Блокът „Одобрения (bfv_admin)“ съдържа поне три примера (упражнение, статия, модерация на форум).
- В панела „Клубове“ (Mock API демо) се визуализират минимум два клуба със статус (active/pending), назначен bfv_admin и броя треньори спрямо лимита.
- Блокът „Роли в платформата“ описва правата на platform_admin, bfv_admin и coach, плюс кратки сценарии по роли.
- Превключвателят „Избери роля“ сменя активната роля в демото; бутоните се деактивират ако ролята няма права. При офлайн запис се показва лента „offline change“ и тост.

### Клубен тест с треньори (coach beta)
1. **Сподели линка:**
   - Ако UI и API са на един домейн (напр. един Render процес), копирай публичния URL и го изпрати на треньорите.
   - Ако UI е отделно (GitHub Pages/Netlify), стартирай/деплойни `prototype/mock_api.py`, вземи публичния адрес и го въведи в полето „Адрес на API“ в секцията „Демо с Mock API“.
   - Индикаторът „Health“ трябва да е зелен при работещ API; при червен статус провери дали `/health` или `/api` отговарят на публичния адрес.
2. **Първа проверка за треньорите:**
   - Натисни „Зареди данни“ (или изчакай автозареждане) и потвърди, че клубовете са със статуси/лимити, а упражненията имат Approved/Pending/Draft.
   - Проследи лентата „Последно обновяване“ и бейджа „Клубен тест · Coach beta“ — те показват дали данните идват от API или fallback.
3. **Мини-сценарии:**
   - Coach предлага упражнение → вижда го с „Чака одобрение“ (примерните данни демонстрират статуса).
   - bfv_admin одобрява/отказва (в демото се вижда промяна в списъците Approved/Pending).
   - Прегледай клубовете и правата в „Преглед по роля“, за да валидирате лимити и отговорности.

### Сценарии за ръчно тестване по роли
- **platform_admin**: създава нов клуб и назначава bfv_admin; вижда статуси на упражнения и може да публикува официални материали; проверява форума и закрепва тема.
- **bfv_admin**: разглежда секцията „Одобрения“, одобрява предложено упражнение и връща друго за корекции; публикува статия и потвърждава, че се вижда като „Публикувано“; модерира сигнал от форум.
- **coach**: филтрира методика/упражнения, добавя упражнения в генератора и запазва тренировка; предлага ново упражнение/материал (вижда статус „Чака одобрение“); публикува тема във форума.

## Хостване (тестване без локална среда)
Статичният фронтенд (`index.html`) може да бъде качен на всеки статичен хостинг (GitHub Pages, Netlify, Vercel). Ако искате да ползвате и mock API-то, качете `prototype/mock_api.py` отделно на услуга, която позволява дълго работещ Python процес (например Render/Railway/Fly.io) и задайте публичния му URL в браузъра.

**Бележка за зависимости:** `requirements.txt` вече включва зависимостите за FastAPI бекенда и Alembic миграциите. За mock API-то няма нужда от външни пакети, но ако инсталирате всичко с `pip install -r requirements.txt`, ще получите и необходимите библиотеки за реалния бекенд.

### Бърз вариант: GitHub Pages (само статичния файл)
1. Създайте публично хранилище и качете `index.html` (и по желание `README.md`).
2. Активирайте **GitHub Pages** (Settings → Pages → Source: Deploy from a branch, папка `/` или `/(root)`).
3. Отворете публикувания URL. Панелът „Демо с Mock API“ ще работи с fallback данни, ако не посочите външно API.

### Бърз вариант: Netlify/Vercel (само статичния файл)
1. Направете нов проект и насочете към хранилището или качете директно `index.html` като „drag & drop“ сайт.
2. Деплойте. Ще получите публичен URL за споделяне; API панелът отново ще ползва fallback, ако няма бекенд.

### Добавяне на външно mock API
1. Деплойте `prototype/mock_api.py` на услуга, която поддържа Python процес/WSGI:
   - Render: нов Web Service, start command `python prototype/mock_api.py`. Платформата подава порта чрез променливата `PORT`, която се използва автоматично.
   - Railway/Fly.io: аналогична конфигурация с публичен порт (напр. 8001 или стойността в `PORT`).
2. След деплой вземете публичния URL, напр. `https://<project>.onrender.com`.
3. Отворете статичния сайт и в панела „Демо с Mock API“ въведете/заменете адреса на API, ако е различен от `http://localhost:8001`, след което натиснете „Зареди данни“. Ако UI и API са на един и същ домейн (примерно Render процес, който сервира и `index.html`, и JSON), полето ще се попълни само с текущия адрес.
   - Може да предадете адреса и ролята директно в линка: `?api=https://<project>.onrender.com&role=coach`, след което да натиснете „Провери health“ и „Зареди данни“.
4. Ако API не е налично, UI-то остава видимо с примерни данни; при налично API статусните бейджове и списъци се пълнят с живите JSON данни.

## Mock API прототип

За да симулирате данни по роли (упражнения, тренировки, права и чакащи одобрения), стартирайте лек HTTP сървър без допълнителни зависимости:

```
python prototype/mock_api.py
```

По подразбиране ще се отвори на `http://localhost:8001` със следните крайни точки:

- `GET /` — кратък списък с наличните крайни точки (ползвайте го като sanity check след деплой)
- `GET /api` — идентичен списък с крайни точки, ако платформата пренасочва root заявките
- `GET /health` — здравен чек за платформи като Render/Railway
- `GET /api/exercises` — примерни упражнения със статуси (approved, pending, draft)
- `GET /api/trainings` — примерни тренировки със статуси (saved, approved)
- `GET /api/clubs` — примерни клубове с текущ статус (active/pending), назначен bfv_admin и броя треньори срещу лимита
- `GET /api/roles` — права по роли (platform_admin, bfv_admin, coach)
- `GET /api/pending` — чакащи одобрения за упражнения, статии и форумни сигнали (групирани по ключове)
- `GET /api/stats` — броячи за упражнения/тренировки/клубове и чакащи (pending_breakdown по ключове)
- `POST /api/pending/exercises` — добавя упражнение в чакащите (coach flow)
- `POST /api/pending/exercises/<id>/approve` — премества упражнението в основния списък със статус approved (приема и `/approve/<id>`)
- `POST /api/pending/exercises/<id>/reject` — премахва упражнението от чакащите (приема и `/reject/<id>`)
- `POST /api/reset` — връща данните към първоначалните стойности и записва във `prototype/data.json`

Файлът `prototype/data.json` се използва като леко „хранилище“ за мок данните (поддържа промени след POST заявки). Пътят може да се
премести с променливата `MOCK_DATA_PATH`, ако платформата изисква друга директория за запис.

**Content negotiation за UI**
- При заявка към `/` или `/index.html` с Accept `text/html` (например директно от браузър), сървърът връща статичния `index.html`, ако файлът съществува до скрипта. Това позволява един и същ процес да сервира и UI, и API на платформи като Render.
- Ако `index.html` липсва или Accept не включва `text/html`, `/` връща JSON списък с крайните точки (API_INTRO). `/api` винаги връща JSON.

Сървърът изпраща CORS заглавки (Access-Control-Allow-Origin: *) и отговаря на `OPTIONS` заявки, за да може статичният UI
(хостнат на друг домейн/порт) да взема данни без допълнителни проксита.

Можете да използвате тези JSON данни в бъдещ интерактивен фронтенд или Postman за бърза проверка на сценарии. В демо панела има
филтри/търсене за упражнения, клубове и чакащи, както и мини-флоу „Предложи упражнение“ + бутони „Одобри/Откажи“, които работят
с API или локален fallback, ако бекендът е недостъпен.

## План за база данни

Докато mock API-то служи за демонстрация, следващата стъпка е да въведем реална база данни (предложение: PostgreSQL) с миграции (напр. Alembic) и начално зареждане на примерни данни. Предложеното изпълнение е разбито на малки фази:

1. **Схема и модели** (седмица 1)
   - Таблици: `users` (роля: platform_admin/bfv_admin/coach), `clubs`, `club_members` (coach към клуб с лимит), `exercises`, `trainings`, `training_items`, `articles`, `pending_items` (упражнения/статии/форуми чакащи одобрение), `forum_topics`/`forum_posts`, `approvals` (одобрил/отказал/коментар), `audit_log`.
   - Връзки: `clubs` ⇄ `bfv_admin_id`; `pending_items` с `submitted_by` и `type`; `exercises` с `approved_by`; `trainings` с `created_by` и свързани упражнения през `training_items`.
   - Миграция: базов файл с начална схема + seed данни, които съвпадат с текущите mock стойности.

2. **API слой върху базата** (седмица 2)
   - REST/GraphQL (минимален FastAPI/Flask) с endpoints, които заменят статичните JSON-и: `/api/exercises`, `/api/trainings`, `/api/clubs`, `/api/roles`, `/api/pending`, `/api/approvals`.
   - Добавяне на POST за „предлагане“ на упражнение/статия (coach) и PATCH/POST за „одобрение/отказ“ (bfv_admin), с транзакции и актуализация на статус.
   - Health check `/health` остава непроменен.

3. **Обвързване с фронтенда** (седмица 3)
   - Wireframe-ът запазва текущата fallback логика, но fetch-ва реалните endpoints; добавяме минимална форма за предлагане на упражнение (POST) и бутони „Одобри/Откажи“ върху записите в pending.
   - Добавяме визуална индикация кога данните идват от база (API OK) vs fallback.

4. **Деплой и конфигурация**
   - Локално: docker-compose с PostgreSQL или облачен dev инстанс; env-променливи `DATABASE_URL`, `PORT` (за API), `ALLOWED_ORIGINS`.
   - Хостинг: managed Postgres (Render/Railway/Fly/Neon). Първоначално деплой на API без auth (само демо), след това добавяне на JWT/AuthN/AuthZ.

5. **Следващи стъпки**
   - Добавяне на реална аутентикация и авторизация по роли, soft-delete/archiving за упражнения/тренировки, и пълни одит логове.
   - Инкрементално мигриране на mock данните към таблиците (еднократно seed-ване + регулярни миграции при промени).

## Backend API (FastAPI + PostgreSQL)
A first cut of the real API now lives under `backend/` using FastAPI, SQLAlchemy, and Alembic with JWT auth. Roles are enforced (`platform_admin`, `bfv_admin`, `coach`) via the shared dependency layer.

### Quickstart (local)
1. Install dependencies: `pip install -r requirements.txt`.
2. Start Postgres locally (or use Docker): `docker-compose up db`.
3. Run the API: `uvicorn backend.app.main:app --reload`.
4. Open http://localhost:8000/docs to exercise the endpoints.

### Docker Compose
* `docker-compose up` starts Postgres and the API together. The API reads `DATABASE_URL` and `JWT_SECRET` from environment variables (defaults are set in `docker-compose.yml`).

### Database migrations
* Alembic config lives in `backend/alembic.ini` with the first migration at `backend/app/migrations/versions/0001_initial.py`.
* To run migrations manually: `alembic -c backend/alembic.ini upgrade head`.

### Seeding data
* Run `python backend/seed_data.py` after the database is up to create platform_admin, bfv_admin, the sample clubs/coaches, and a demo article.
* If `/mnt/data/volleyball_exercises_normalized.xlsx` exists, it will be imported into the `exercises` table; if not present, seeding skips the Excel import.

### Initial endpoints (MVP scope)
* Auth: `/auth/login`, `/auth/me` (JWT bearer)
* Clubs: create/list, add coaches (role-gated)
* Exercises: list/create/approve, suggestions propose/approve
* Trainings: create/list with exercise assignments
* Articles: publish list/create and suggestion approval
* Forum: categories → topics → posts (create/list)
* Health: `/health`

### Roadmap alignment
This backend skeleton aligns with the codified plan: FastAPI + Postgres + JWT + RBAC, Alembic migrations, seed users/clubs, and room to grow toward the React frontend and deployment to Render.
